<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Post Maker ‚Äî Indic Safe + BG Image</title>

  <!-- Base fonts (fallbacks) -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;600;800&family=Mukta:wght@400;600;800&family=Hind:wght@400;600;700&family=Karma:wght@400;700&family=Martel:wght@400;800&family=Poppins:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{--line:#1f2630;--ink:#e8ecf1;--muted:#9aa3ad}
    *{box-sizing:border-box}
    body{margin:0;background:#0a0c10;color:var(--ink);font-family:"Noto Sans Devanagari","Poppins",system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .container{max-width:1200px;margin:auto;padding:12px}
    .previewCard{background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:16px;padding:12px}
    .stage{display:grid;place-items:center;position:relative;min-height:40vh}
    canvas{max-width:100%;border-radius:14px;background:#000;display:block}
    .btn{background:#121a24;border:1px solid #24303f;color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700}
    .btn.primary{background:linear-gradient(135deg,#60a5fa,#34d399);color:#081017;border:none}
    .controls{margin-top:14px;display:grid;gap:12px;grid-template-columns:1fr}
    @media (min-width:900px){.controls{grid-template-columns:1fr 1fr}.full{grid-column:1/-1}}
    .section{background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:16px;padding:14px}
    .section h3{margin:2px 0 10px;font-size:16px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{width:100%;background:#0f141c;border:1px solid #273342;color:var(--ink);border-radius:10px;padding:8px;font-size:14px}
    input[type=color]{padding:0;height:40px}
    textarea{min-height:78px;resize:vertical}
    .chip{display:flex;align-items:center;gap:6px;border:1px dashed #2a3443;border-radius:12px;padding:6px}
    .small{font-size:11px;color:#9aa3ad}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:8px}
  </style>
</head>
<body>
  <div class="container">
    <!-- PREVIEW FIRST -->
    <div class="previewCard">
      <div class="stage"><canvas id="c" width="1080" height="1080"></canvas></div>
      <div class="row">
        <div>
          <select id="format"><option value="png">PNG</option><option value="jpeg">JPEG</option><option value="webp">WebP</option></select>
          <select id="scale"><option value="1">1√ó</option><option value="2" selected>2√ó</option><option value="3">3√ó</option></select>
          <input type="range" id="quality" min="0.7" max="1" step="0.01" value="0.95" title="Quality">
          <span class="small">Drag BG/Logos ‚Ä¢ Shift+Wheel = Zoom</span>
        </div>
        <button class="btn primary" id="download">‚¨áÔ∏è Download</button>
      </div>
    </div>

    <!-- CONTROLS BELOW -->
    <div class="controls">

      <!-- BACKGROUND -->
      <div class="section full">
        <h3>Background</h3>
        <div class="grid2">
          <div>
            <label>BG Image</label>
            <input type="file" id="bgImageInput" accept="image/*">
          </div>
          <div>
            <label>Blend Order</label>
            <select id="bgBlend">
              <option value="under" selected>Gradient over Image</option>
              <option value="over">Image over Gradient</option>
              <option value="imageOnly">Image Only (no gradient)</option>
              <option value="gradientOnly">Gradient Only</option>
            </select>
          </div>
        </div>
        <div class="grid3" style="margin-top:8px">
          <div><label>Image Opacity</label><input type="range" id="bgImgOpacity" min="0" max="1" step="0.05" value="1"></div>
          <div><label>Image Scale</label><input type="range" id="bgImgScale" min="0.2" max="3" step="0.02" value="1"></div>
          <div>
            <label>Tint Color</label><input type="color" id="bgImgTint" value="#ffffff">
          </div>
        </div>
        <div class="grid2" style="margin-top:8px">
          <div>
            <label>Tint Mode</label>
            <select id="bgTintMode">
              <option value="none" selected>None</option>
              <option value="multiply">Multiply</option>
              <option value="screen">Screen</option>
              <option value="overlay">Overlay</option>
              <option value="soft-light">Soft Light</option>
            </select>
          </div>
          <div><label>Vignette</label><input type="range" id="vignette" min="0" max="100" value="20"></div>
        </div>

        <div class="grid3" style="margin-top:12px">
          <div><label>Gradient Top</label><input type="color" id="bg1" value="#ffffff"></div>
          <div><label>Gradient Middle</label><input type="color" id="bg2" value="#1976D2"></div>
          <div><label>Gradient Bottom</label><input type="color" id="bg3" value="#000000"></div>
        </div>
        <div class="grid3" style="margin-top:8px">
          <div><label>Gradient Angle</label><input type="range" id="bgAngle" min="0" max="360" value="90"></div>
          <div><label>Safe Padding (%)</label><input type="range" id="padding" min="0" max="15" value="5"></div>
          <div>
            <label>Size Preset</label>
            <select id="preset">
              <option value="1080x1080" selected>IG/FB Square ‚Äî 1080√ó1080</option>
              <option value="1080x1920">Story/Reel ‚Äî 1080√ó1920</option>
              <option value="1080x1350">IG Portrait ‚Äî 1080√ó1350</option>
              <option value="1640x924">FB Cover ‚Äî 1640√ó924</option>
              <option value="1280x720">YT/Telegram 16:9 ‚Äî 1280√ó720</option>
              <option value="1280x1280">Telegram Square ‚Äî 1280√ó1280</option>
              <option value="custom">Custom‚Ä¶</option>
            </select>
          </div>
        </div>
        <div class="grid2" style="margin-top:8px">
          <input id="cw" type="number" min="320" value="1080" title="Width (px)">
          <input id="ch" type="number" min="320" value="1080" title="Height (px)">
        </div>
        <div class="small" style="margin-top:6px">üñ±Ô∏è Background image ‡§ï‡•ã canvas ‡§™‡§∞ Drag ‡§ï‡§∞‡•á‡§Ç ‚Ä¢ Shift + Wheel = Zoom</div>
      </div>

      <!-- TOP TITLE -->
      <div class="section">
        <h3>Top Title</h3>
        <input id="topTitle" placeholder="Add top title‚Ä¶">
        <div class="grid3" style="margin-top:8px">
          <div><label>Font</label><select id="topFont"></select></div>
          <div><label>Size</label><input type="range" id="topSize" min="20" max="100" value="48"></div>
          <div><label>Y-pos %</label><input type="range" id="topY" min="6" max="30" value="12"></div>
        </div>
        <div class="grid3" style="margin-top:8px">
          <div><label>Grad A</label><input type="color" id="top1" value="#ff3d00"></div>
          <div><label>Grad B</label><input type="color" id="top2" value="#ffff00"></div>
          <div><label>Angle</label><input type="range" id="topAngle" min="0" max="360" value="0"></div>
        </div>
      </div>

      <!-- MAIN HEADING (Indic-safe) -->
      <div class="section">
        <h3>Main Heading</h3>
        <textarea id="title" placeholder="(Multi-line allowed)‚Ä¶"></textarea>
        <div class="grid3" style="margin-top:8px">
          <div><label>Font</label><select id="font"></select></div>
          <div><label>Weight</label><select id="weight"><option>400</option><option selected>600</option><option>800</option></select></div>
          <div><label>Base Size</label><input type="range" id="titleSize" min="28" max="160" value="96"></div>
        </div>
        <div class="grid3" style="margin-top:8px">
          <div><label>Line Height</label><input type="range" id="lineHeight" min="1" max="1.6" step="0.02" value="1.15"></div>
          <div><label>Letter Spacing</label><input type="range" id="letter" min="-1" max="4" step="0.1" value="0"></div>
          <div><label>Align</label><select id="align"><option>center</option><option>left</option><option>right</option></select></div>
        </div>
        <div class="grid3" style="margin-top:8px">
          <div><label>Text Grad A</label><input type="color" id="t1" value="#40c9ff"></div>
          <div><label>Text Grad B</label><input type="color" id="t2" value="#f7b733"></div>
          <div><label>Text Grad C</label><input type="color" id="t3" value="#7cffcb"></div>
        </div>
        <div class="grid3" style="margin-top:8px">
          <div><label>Grad Angle</label><input type="range" id="tAngle" min="0" max="360" value="0"></div>
          <div><label>Outline (px)</label><input type="range" id="outline" min="0" max="20" value="6"></div>
          <div><label>Glow</label><input type="range" id="glow" min="0" max="60" value="22"></div>
        </div>
        <div class="grid2" style="margin-top:8px">
          <div><label>Title Y-pos %</label><input type="range" id="titleY" min="25" max="70" value="40"></div>
          <div><label>Disable Letter Spacing (Indic)</label>
            <select id="indicMode"><option value="auto" selected>Auto</option><option value="forceOn">Force ON</option><option value="forceOff">Force OFF</option></select>
          </div>
        </div>
      </div>

      <!-- BOTTOM BRANDING -->
      <div class="section">
        <h3>Bottom Branding</h3>
        <input id="brand" placeholder="eg. ‡§∞‡•ã‡§ö‡§ï ‡§î‡§∞ ‡§ú‡•ç‡§û‡§æ‡§® ‡§ï‡•Ä ‡§¨‡§æ‡§§‡•á‡§Ç">
        <div class="grid3" style="margin-top:8px">
          <div><label>Size</label><input type="range" id="brandSize" min="18" max="72" value="40"></div>
          <div><label>Offset %</label><input type="range" id="brandOffset" min="2" max="15" value="6"></div>
          <div><label>Glow</label><input type="range" id="bGlow" min="0" max="50" value="10"></div>
        </div>
        <div class="grid3" style="margin-top:8px">
          <div><label>Grad A</label><input type="color" id="b1" value="#ff8a00"></div>
          <div><label>Grad B</label><input type="color" id="b2" value="#ffd000"></div>
          <div><label>Grad C</label><input type="color" id="b3" value="#ffa24c"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
  const c=document.getElementById('c'),ctx=c.getContext('2d'); const $=id=>document.getElementById(id);

  // ----- Fonts list -----
  const fonts=[
    "Noto Sans Devanagari","Mukta","Hind","Karma","Martel",
    "Poppins","Inter","Roboto","Montserrat","Merriweather","Lora","Playfair Display","Nunito","Manrope","Raleway","Oswald"
  ];
  ["font","topFont"].forEach(id=>{
    const sel=$(id); fonts.forEach(f=>{const o=document.createElement('option');o.value=f;o.textContent=f;sel.appendChild(o);});
    if(id==="font") sel.value="Noto Sans Devanagari"; else sel.value="Poppins";
  });

  function loadFont(f){ // lazy load
    const id='gf_'+f.replace(/\s+/g,'_'); if(document.getElementById(id)) return;
    const link=document.createElement('link'); link.id=id; link.rel='stylesheet';
    link.href=`https://fonts.googleapis.com/css2?family=${encodeURIComponent(f)}:wght@400;600;800&display=swap`;
    document.head.appendChild(link);
    // try ensure render after load
    document.fonts && document.fonts.load(`12px "${f}"`).then(()=>draw());
  }

  // ----- BG image state & drag -----
  const BG={img:null,x:0,y:0,scale:1,opacity:1,tint:"#ffffff",tintMode:"none"};
  let drag = {mode:null,dx:0,dy:0}; // mode: 'BG'

  $('bgImageInput').addEventListener('change',e=>{
    const file=e.target.files[0]; if(!file) return;
    const img=new Image();
    img.onload=()=>{ BG.img=img; BG.scale= Math.max(c.width/img.naturalWidth, c.height/img.naturalHeight); BG.x=c.width/2; BG.y=c.height/2; draw(); };
    img.src=URL.createObjectURL(file);
    e.target.value='';
  });

  c.addEventListener('mousedown',e=>{
    const r=c.getBoundingClientRect(), mx=(e.clientX-r.left)*(c.width/r.width), my=(e.clientY-r.top)*(c.height/r.height);
    if(BG.img){
      const iw=BG.img.naturalWidth*BG.scale, ih=BG.img.naturalHeight*BG.scale;
      if(mx>BG.x-iw/2 && mx<BG.x+iw/2 && my>BG.y-ih/2 && my<BG.y+ih/2){ drag={mode:'BG',dx:mx-BG.x,dy:my-BG.y}; return; }
    }
    drag.mode=null;
  });
  window.addEventListener('mousemove',e=>{
    if(!drag.mode) return;
    const r=c.getBoundingClientRect(), mx=(e.clientX-r.left)*(c.width/r.width), my=(e.clientY-r.top)*(c.height/r.height);
    if(drag.mode==='BG'){ BG.x=mx-drag.dx; BG.y=my-drag.dy; draw(); }
  });
  window.addEventListener('mouseup',()=> drag.mode=null);
  c.addEventListener('wheel',e=>{
    if(!e.shiftKey) return;
    if(BG.img){ BG.scale = Math.max(0.2, Math.min(3, BG.scale*(1 - e.deltaY*0.0015))); draw(); e.preventDefault(); }
  },{passive:false});

  // ----- Helpers -----
  function makeGrad(W,H,a,stops){ const rad=a*Math.PI/180, vx=Math.cos(rad), vy=Math.sin(rad);
    const x0=W*(.5-.5*vx), y0=H*(.5-.5*vy), x1=W*(.5+.5*vx), y1=H*(.5+.5*vy);
    const g=ctx.createLinearGradient(x0,y0,x1,y1); stops.forEach(s=>g.addColorStop(s.pos,s.c)); return g; }
  function hexToRgb(h){h=h.replace('#','');if(h.length===3)h=[...h].map(x=>x+x).join('');const n=parseInt(h,16);return[n>>16&255,n>>8&255,n&255];}
  const HAS_DEV = s=>/[\u0900-\u097F]/.test(s);  // Devanagari detection

  // ----- Draw -----
  function draw(){
    // size
    const W=+$('cw').value, H=+$('ch').value; c.width=W; c.height=H;
    const pad=Math.round(Math.min(W,H)*(+$('padding').value/100));

    // BG: image+gradient blend
    ctx.clearRect(0,0,W,H);
    const blend=$('bgBlend').value;

    if(BG.img && (blend==='under' || blend==='imageOnly')) drawBgImage(W,H);
    if(blend!=='imageOnly'){
      ctx.fillStyle=makeGrad(W,H,+$('bgAngle').value,[{c:$('bg1').value,pos:0},{c:$('bg2').value,pos:.5},{c:$('bg3').value,pos:1}]);
      ctx.fillRect(0,0,W,H);
    }
    if(BG.img && blend==='over') drawBgImage(W,H);

    // Vignette
    const vig=+$('vignette').value/100;
    if(vig>0){
      const g=ctx.createRadialGradient(W/2,H/2,Math.min(W,H)*(0.6-0.6*vig),W/2,H/2,Math.max(W,H)*0.8);
      g.addColorStop(0,'rgba(0,0,0,0)'); g.addColorStop(1,`rgba(0,0,0,${0.55*vig})`);
      ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
    }

    // TOP TITLE
    const topText=$('topTitle').value.trim();
    if(topText){
      const f=$('topFont').value; loadFont(f);
      ctx.save();
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.font=`800 ${+$('topSize').value}px "${f}"`;
      const tg=makeGrad(W,H,+$('topAngle').value,[{c:$('top1').value,pos:0},{c:$('top2').value,pos:1}]);
      ctx.fillStyle=tg;
      ctx.fillText(topText, W/2, H*(+$('topY').value/100));
      ctx.restore();
    }

    // MAIN HEADING (Indic-safe)
    const text=$('title').value;
    if(text.trim()){
      const fam=$('font').value; loadFont(fam);
      const base=+$('titleSize').value, lh=+$('lineHeight').value, wght=$('weight').value;
      const align=$('align').value, x= align==='left'? pad : (align==='right'? W-pad : W/2);
      const y0= H*(+$('titleY').value/100);
      const outline=+$('outline').value, glow=+$('glow').value;
      const tg=makeGrad(W,H,+$('tAngle').value,[{c:$('t1').value,pos:0},{c:$('t2').value,pos:.5},{c:$('t3').value,pos:1}]);

      const isIndic = $('indicMode').value==='forceOn' ? true : ($('indicMode').value==='forceOff' ? false : HAS_DEV(text));
      // If Indic ‚Üí ignore letter spacing to preserve ligatures
      const letter = isIndic ? 0 : +$('letter').value;

      ctx.save();
      ctx.textAlign=align; ctx.textBaseline='alphabetic';
      ctx.shadowBlur=glow; ctx.shadowColor='rgba(0,0,0,0.55)';
      ctx.lineJoin="round"; ctx.miterLimit=2;

      const lines=text.split('\n');
      for(let i=0;i<lines.length;i++){
        const line=lines[i];
        ctx.font=`${wght} ${base}px "${fam}"`;
        const y = y0 + i*base*lh;

        // Outline first
        if(outline>0){
          ctx.lineWidth=outline;
          ctx.strokeStyle=makeGrad(W,H,90,[{c:'rgba(0,0,0,0.85)',pos:0},{c:'rgba(0,0,0,0.25)',pos:1}]);
          if(letter===0){ ctx.strokeText(line, x, y); }
          else{ drawWithLetterSpacing('stroke', line, x, y, letter, align); }
        }
        // Fill
        ctx.fillStyle=tg;
        if(letter===0){ ctx.fillText(line, x, y); }
        else{ drawWithLetterSpacing('fill', line, x, y, letter, align); }
      }
      ctx.restore();

      // disable/enable slider visually
      $('letter').disabled = isIndic;
      $('letter').title = isIndic ? 'Indic text detected ‚Äî letter spacing disabled to preserve ligatures' : 'Letter spacing';
    }

    // BOTTOM BRAND
    const brand=$('brand').value.trim();
    if(brand){
      const size=+$('brandSize').value, off=+$('brandOffset').value/100*H;
      const bg=makeGrad(W,H,0,[{c:$('b1').value,pos:0},{c:$('b2').value,pos:.5},{c:$('b3').value,pos:1}]);
      const fam=$('font').value; loadFont(fam);
      ctx.save(); ctx.textAlign='center'; ctx.textBaseline='bottom';
      ctx.font=`600 ${size}px "${fam}"`; ctx.shadowBlur=+$('bGlow').value; ctx.shadowColor='rgba(0,0,0,0.35)';
      ctx.fillStyle=bg; ctx.fillText(brand, W/2, H-off); ctx.restore();
    }
  }

  function drawWithLetterSpacing(mode, text, x, y, spacing, align){
    // draw whole runs but adjust position (non-Indic use only)
    ctx.save(); const w = ctx.measureText(text).width + spacing*(text.length-1);
    if(align==='center') x -= w/2; else if(align==='right') x -= w;
    for(let i=0;i<text.length;i++){
      const ch=text[i]; ctx[mode+'Text'](ch, x, y); x += ctx.measureText(ch).width + spacing;
    }
    ctx.restore();
  }

  function drawBgImage(W,H){
    if(!BG.img) return;
    const iw=BG.img.naturalWidth*BG.scale, ih=BG.img.naturalHeight*BG.scale;
    // image
    ctx.save();
    ctx.globalAlpha=+$('bgImgOpacity').value;
    ctx.drawImage(BG.img, BG.x - iw/2, BG.y - ih/2, iw, ih);
    // tint
    const mode=$('bgTintMode').value;
    if(mode!=='none'){
      ctx.globalCompositeOperation = mode;
      ctx.fillStyle = $('bgImgTint').value;
      ctx.fillRect(0,0,W,H);
      ctx.globalCompositeOperation = 'source-over';
    }
    ctx.restore();
  }

  // ----- Bind controls -----
  document.querySelectorAll('input,select,textarea').forEach(el=> el.addEventListener('input',()=>{ if(el.id==='font'||el.id==='topFont') loadFont(el.value); draw(); }));
  document.getElementById('preset').addEventListener('change',()=>{
    const v=$('preset').value; if(v!=='custom'){ const [w,h]=v.split('x').map(Number); $('cw').value=w; $('ch').value=h; } draw();
  });

  // Download
  $('download').onclick=()=>{
    const scale=+$('scale').value, fmt=$('format').value, q=+$('quality').value;
    const tmp=document.createElement('canvas'); tmp.width=c.width*scale; tmp.height=c.height*scale;
    const t=tmp.getContext('2d'); t.imageSmoothingQuality='high'; t.drawImage(c,0,0,tmp.width,tmp.height);
    const mime= fmt==='png'?'image/png':(fmt==='jpeg'?'image/jpeg':'image/webp');
    const url=tmp.toDataURL(mime,q); const a=document.createElement('a'); a.href=url; a.download=`post_${tmp.width}x${tmp.height}.${fmt}`; a.click();
  };

  // Init
  loadFont("Noto Sans Devanagari"); loadFont("Poppins");
  draw();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Post Maker ‚Äî Enhanced Version with Additional Features</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;600;800&family=Mukta:wght@400;600;800&family=Hind:wght@400;600;700&family=Karma:wght@400;700&family=Martel:wght@400;800&family=Poppins:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { 
      --line:#1f2630; 
      --ink:#e8ecf1; 
      --muted:#9aa3ad; 
      --success:#10b981; 
      --warning:#f59e0b; 
      --error:#ef4444;
      --accent:#8b5cf6;
    }
    * { box-sizing:border-box; }
    body { 
      margin:0; 
      background:#0a0c10; 
      color:var(--ink); 
      font-family:"Noto Sans Devanagari","Poppins",system-ui,Segoe UI,Roboto,Arial,sans-serif; 
    }
    
    .container { 
      display:flex; 
      flex-direction:column; 
      gap:16px; 
      max-width:1400px; 
      margin:auto; 
      padding:12px; 
    }
    
    @media (min-width:1000px){
      .container { 
        flex-direction:row; 
        align-items:flex-start; 
      }
      .previewCard { 
        flex:1; 
        max-width:600px; 
        position: sticky;
        top: 20px;
      }
      .controls { 
        flex:1.5; 
      }
    }
    
    .previewCard { 
      background:rgba(255,255,255,.03); 
      border:1px solid var(--line); 
      border-radius:16px; 
      padding:12px; 
      backdrop-filter: blur(8px);
    }
    
    .stage { 
      display:grid; 
      place-items:center; 
      position:relative; 
      min-height:40vh; 
    }
    
    canvas { 
      width:100%; 
      max-width:100%; 
      border-radius:14px; 
      background:#000; 
      display:block; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      transition: transform 0.2s ease;
    }
    
    canvas:hover {
      transform: scale(1.02);
    }
    
    .btn { 
      background:#121a24; 
      border:1px solid #24303f; 
      color:var(--ink); 
      padding:10px 14px; 
      border-radius:12px; 
      cursor:pointer; 
      font-weight:700; 
      transition: all 0.2s; 
      position: relative;
      overflow: hidden;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.5s;
    }
    
    .btn:hover::before {
      left: 100%;
    }
    
    .btn:hover { 
      background:#1e2830; 
      transform: translateY(-2px);
    }
    
    .btn.primary { 
      background:linear-gradient(135deg,#60a5fa,#34d399); 
      color:#081017; 
      border:none; 
    }
    
    .btn.success { 
      background:var(--success); 
      color:white; 
    }
    
    .btn.warning { 
      background:var(--warning); 
      color:white; 
    }
    
    .btn.accent {
      background: var(--accent);
      color: white;
    }
    
    .controls { 
      display:grid; 
      gap:12px; 
      grid-template-columns:1fr; 
    }
    
    @media (min-width:900px){ 
      .controls{ 
        grid-template-columns:1fr 1fr; 
      } 
      .full{ 
        grid-column:1/-1; 
      } 
    }
    
    .section { 
      background:rgba(255,255,255,.03); 
      border:1px solid var(--line); 
      border-radius:16px; 
      padding:14px; 
      backdrop-filter: blur(4px);
      transition: all 0.3s ease;
    }
    
    .section:hover {
      border-color: var(--accent);
      background: rgba(255,255,255,.05);
    }
    
    .section h3 { 
      margin:2px 0 10px; 
      font-size:16px; 
      background: linear-gradient(45deg, var(--accent), var(--success));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .grid1 { display:grid; grid-template-columns:1fr; gap:10px; }
    .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .grid3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
    .grid4 { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; }
    
    label { 
      font-size:12px; 
      color:var(--muted); 
      font-weight: 500;
    }
    
    input,select,textarea { 
      width:100%; 
      background:#0f141c; 
      border:1px solid #273342; 
      color:var(--ink); 
      border-radius:10px; 
      padding:8px; 
      font-size:14px; 
      transition: all 0.2s;
    }
    
    input[type=color]{ 
      padding:0; 
      height:40px; 
      cursor: pointer;
    }
    
    input:focus, select:focus, textarea:focus { 
      border-color: var(--success); 
      outline: none; 
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
    
    textarea{ 
      min-height:78px; 
      resize:vertical; 
      font-family: inherit;
    }
    
    .chip{ 
      display:flex; 
      align-items:center; 
      gap:6px; 
      border:1px dashed #2a3443; 
      border-radius:12px; 
      padding:6px; 
    }
    
    .small{ 
      font-size:11px; 
      color:#9aa3ad; 
    }
    
    .row{ 
      display:flex; 
      gap:8px; 
      flex-wrap:wrap; 
      align-items:center; 
      justify-content:space-between; 
      margin-top:8px; 
    }
    
    .toast { 
      position: fixed; 
      top: 20px; 
      right: 20px; 
      background: var(--success); 
      color: white; 
      padding: 12px 20px; 
      border-radius: 8px; 
      z-index: 1000; 
      transform: translateX(300px); 
      transition: transform 0.3s; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    
    .toast.show { 
      transform: translateX(0); 
    }
    
    .toast.error {
      background: var(--error);
    }
    
    .toast.warning {
      background: var(--warning);
    }
    
    .logo-chip { 
      border: 1px solid #2a3443; 
      border-radius: 12px; 
      padding: 8px; 
      margin: 4px 0; 
      background: rgba(255,255,255,0.02); 
      transition: all 0.2s;
    }
    
    .logo-chip:hover {
      background: rgba(255,255,255,0.05);
      border-color: var(--accent);
    }
    
    .logo-controls { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); 
      gap: 4px; 
      align-items: center; 
      margin-top: 4px; 
    }
    
    .logo-controls input, .logo-controls select, .logo-controls button { 
      font-size: 11px; 
      padding: 4px; 
      height: 28px; 
    }
    
    .logo-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 4px; 
    }
    
    .logo-title { 
      font-size: 12px; 
      font-weight: 600; 
      color: var(--ink); 
    }

    /* New features styling */
    .template-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .template-item {
      background: rgba(255,255,255,0.05);
      border: 1px solid #2a3443;
      border-radius: 8px;
      padding: 8px;
      cursor: pointer;
      text-align: center;
      font-size: 12px;
      transition: all 0.2s;
    }

    .template-item:hover {
      border-color: var(--accent);
      background: rgba(139, 92, 246, 0.1);
    }

    .history-item {
      background: rgba(255,255,255,0.02);
      border: 1px solid #2a3443;
      border-radius: 8px;
      padding: 6px;
      margin: 4px 0;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .history-item:hover {
      background: rgba(255,255,255,0.05);
      border-color: var(--success);
    }

    .export-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .shortcut-help {
      background: rgba(139, 92, 246, 0.1);
      border: 1px solid var(--accent);
      border-radius: 8px;
      padding: 8px;
      margin-top: 8px;
      font-size: 11px;
    }

    .layer-panel {
      max-height: 200px;
      overflow-y: auto;
    }

    .layer-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px;
      margin: 2px 0;
      background: rgba(255,255,255,0.02);
      border-radius: 6px;
      font-size: 12px;
    }

    .progress-bar {
      width: 100%;
      height: 4px;
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
      overflow: hidden;
      margin: 4px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--success));
      width: 0%;
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- PREVIEW -->
    <div class="previewCard">
      <div class="stage">
        <canvas id="c" width="1080" height="1080"></canvas>
        <div class="progress-bar" id="progressBar" style="display: none;">
          <div class="progress-fill" id="progressFill"></div>
        </div>
      </div>
      <div class="row">
        <div>
          <select id="format"><option value="png">PNG</option><option value="jpeg">JPEG</option><option value="webp">WebP</option></select>
          <select id="scale"><option value="1">1√ó</option><option value="2" selected>2√ó</option><option value="3">3√ó</option><option value="4">4√ó</option></select>
          <input type="range" id="quality" min="0.7" max="1" step="0.01" value="0.95" title="Quality">
          <span class="small">Drag BG/Logos ‚Ä¢ Shift+Wheel Resize ‚Ä¢ Ctrl+Drag Circle</span>
        </div>
        <div>
          <button class="btn accent" id="undoBtn">‚Ü∂ Undo</button>
          <button class="btn accent" id="redoBtn">‚Ü∑ Redo</button>
          <button class="btn success" id="saveSettings">üíæ Save</button>
          <button class="btn warning" id="loadSettings">üìÇ Load</button>
          <button class="btn primary" id="download">‚¨áÔ∏è Download</button>
        </div>
      </div>
    </div>

    <!-- CONTROLS -->
    <div class="controls">
      <!-- TEMPLATES -->
      <div class="section full">
        <h3>Quick Templates</h3>
        <div class="template-grid">
          <div class="template-item" data-template="social">üì± Social Media</div>
          <div class="template-item" data-template="business">üíº Business</div>
          <div class="template-item" data-template="event">üéâ Event</div>
          <div class="template-item" data-template="minimal">‚ú® Minimal</div>
          <div class="template-item" data-template="vibrant">üåà Vibrant</div>
          <div class="template-item" data-template="elegant">üëë Elegant</div>
        </div>
      </div>

      <!-- BACKGROUND -->
      <div class="section full">
        <h3>Background</h3>
        <div class="grid3">
          <div><label>BG Image</label><input type="file" id="bgImageInput" accept="image/*"></div>
          <div><label>Blend Order</label>
            <select id="bgBlend">
              <option value="under">Gradient over Image</option>
              <option value="over">Image over Gradient</option>
              <option value="imageOnly">Image Only</option>
              <option value="gradientOnly">Gradient Only</option>
            </select>
          </div>
          <div><label>BG Shape</label>
            <select id="bgShape">
              <option value="full" selected>Full</option>
              <option value="circle">Circle</option>
            </select>
          </div>
        </div>
        
        <div class="grid3" style="margin-top:8px">
          <div><label>Image Opacity</label><input type="range" id="bgImgOpacity" min="0" max="1" step="0.05" value="1"></div>
          <div><label>Image Scale</label><input type="range" id="bgImgScale" min="0.2" max="3" step="0.02" value="1"></div>
          <div><label>Tint Color</label><input type="color" id="bgImgTint" value="#ffffff"></div>
        </div>

        <div class="grid2" style="margin-top:8px">
          <div><label>Image Blend Direction</label>
            <select id="bgBlendDir">
              <option value="none" selected>None</option>
              <option value="top">Top</option>
              <option value="bottom">Bottom</option>
              <option value="left">Left</option>
              <option value="right">Right</option>
            </select>
          </div>
          <div><label>Blend Strength</label><input type="range" id="bgBlendStrength" min="0" max="1" step="0.05" value="0"></div>
        </div>
        
        <div class="grid3" style="margin-top:8px">
          <div><label>Tint Mode</label>
            <select id="bgTintMode">
              <option value="none" selected>None</option>
              <option value="multiply">Multiply</option>
              <option value="screen">Screen</option>
              <option value="overlay">Overlay</option>
              <option value="soft-light">Soft Light</option>
            </select>
          </div>
          <div><label>Vignette</label><input type="range" id="vignette" min="0" max="100" value="20"></div>
          <div><label>Safe Padding (%)</label><input type="range" id="padding" min="0" max="15" value="5"></div>
        </div>

        <!-- Gradient colors -->
        <div class="grid3" style="margin-top:12px">
          <div><label>Gradient Top</label><input type="color" id="bg1" value="#ffffff"></div>
          <div><label>Gradient Mid</label><input type="color" id="bg2" value="#1976D2"></div>
          <div><label>Gradient Bottom</label><input type="color" id="bg3" value="#000000"></div>
        </div>

        <div class="grid3" style="margin-top:8px">
          <div><label>Gradient Angle</label><input type="range" id="bgAngle" min="0" max="360" value="90"></div>
          <div><label>Gradient Opacity</label><input type="range" id="gradOpacity" min="0" max="1" step="0.05" value="0.6"></div>
          <div>
            <label>Gradient Blend</label>
            <select id="gradBlend">
              <option value="source-over" selected>Normal</option>
              <option value="multiply">Multiply</option>
              <option value="screen">Screen</option>
              <option value="overlay">Overlay</option>
              <option value="soft-light">Soft Light</option>
              <option value="hard-light">Hard Light</option>
            </select>
          </div>
        </div>

        <!-- Canvas size -->
        <div class="grid3" style="margin-top:8px">
          <div><label>Canvas Preset</label>
            <select id="preset">
              <option value="1080x1080" selected>IG/FB Square ‚Äî 1080√ó1080</option>
              <option value="1080x1920">Story/Reel ‚Äî 1080√ó1920</option>
              <option value="1080x1350">IG Portrait ‚Äî 1080√ó1350</option>
              <option value="1640x924">FB Cover ‚Äî 1640√ó924</option>
              <option value="1280x720">YT/Telegram ‚Äî 1280√ó720</option>
              <option value="1280x1280">Telegram Square ‚Äî 1280√ó1280</option>
              <option value="custom">Custom‚Ä¶</option>
            </select>
          </div>
          <div class="grid2">
            <input id="cw" type="number" min="320" value="1080" title="Width (px)">
            <input id="ch" type="number" min="320" value="1080" title="Height (px)">
          </div>
          <div></div>
        </div>

        <!-- Circle BG controls -->
        <div id="circleControls" class="grid3" style="margin-top:12px; display:none">
          <div><label>Circle X (%)</label><input type="range" id="circleX" min="10" max="90" value="50"></div>
          <div><label>Circle Y (%)</label><input type="range" id="circleY" min="10" max="90" value="35"></div>
          <div><label>Radius (%)</label><input type="range" id="circleR" min="10" max="45" value="28"></div>
          <div><label>Circle Opacity</label><input type="range" id="circleOpacity" min="0.1" max="1" step="0.05" value="1"></div>
        </div>
      </div>

      <!-- TOP TITLE -->
      <div class="section">
        <h3>Top Title</h3>
        <input id="topTitle" placeholder="Add top title‚Ä¶">
        <div class="grid3" style="margin-top:8px">
          <div><label>Font</label><select id="topFont"></select></div>
          <div><label>Size</label><input type="range" id="topSize" min="20" max="100" value="48"></div>
          <div><label>Y-pos %</label><input type="range" id="topY" min="6" max="30" value="12"></div>
        </div>
        <div class="grid3" style="margin-top:8px">
          <div><label>Grad A</label><input type="color" id="top1" value="#ff3d00"></div>
          <div><label>Grad B</label><input type="color" id="top2" value="#ffff00"></div>
          <div><label>Angle</label><input type="range" id="topAngle" min="0" max="360" value="0"></div>
        </div>
      </div>

      <!-- MAIN HEADING -->
      <div class="section">
        <h3>Main Heading</h3>
        <textarea id="title" placeholder="(Multi-line allowed)‚Ä¶"></textarea>
        <div class="grid3" style="margin-top:8px">
          <div><label>Font</label><select id="font"></select></div>
          <div><label>Weight</label><select id="weight"><option>400</option><option selected>600</option><option>800</option></select></div>
          <div><label>Base Size</label><input type="range" id="titleSize" min="28" max="160" value="96"></div>
        </div>
        <div class="grid3" style="margin-top:8px">
          <div><label>Line Height</label><input type="range" id="lineHeight" min="1" max="1.6" step="0.02" value="1.15"></div>
          <div><label>Letter Spacing</label><input type="range" id="letter" min="-1" max="4" step="0.1" value="0"></div>
          <div><label>Align</label><select id="align"><option>center</option><option>left</option><option>right</option></select></div>
        </div>
        <div class="grid3" style="margin-top:8px">
          <div><label>Text Grad A</label><input type="color" id="t1" value="#40c9ff"></div>
          <div><label>Text Grad B</label><input type="color" id="t2" value="#f7b733"></div>
          <div><label>Text Grad C</label><input type="color" id="t3" value="#7cffcb"></div>
        </div>
        <div class="grid3" style="margin-top:8px">
          <div><label>Grad Angle</label><input type="range" id="tAngle" min="0" max="360" value="0"></div>
          <div><label>Outline (px)</label><input type="range" id="outline" min="0" max="20" value="6"></div>
          <div><label>Glow</label><input type="range" id="glow" min="0" max="60" value="22"></div>
        </div>
        <div class="grid2" style="margin-top:8px">
          <div><label>Title Y-pos %</label><input type="range" id="titleY" min="25" max="70" value="40"></div>
          <div><label>Indic Mode</label><select id="indicMode"><option value="auto" selected>Auto</option><option value="forceOn">Force ON</option><option value="forceOff">Force OFF</option></select></div>
        </div>
      </div>

      <!-- BOTTOM BRANDING -->
      <div class="section">
        <h3>Bottom Branding</h3>
        <input id="brand" placeholder="eg. Add Your Bottom Title">
        <div class="grid3" style="margin-top:8px">
          <div><label>Size</label><input type="range" id="brandSize" min="18" max="72" value="40"></div>
          <div><label>Offset %</label><input type="range" id="brandOffset" min="2" max="15" value="6"></div>
          <div><label>Glow</label><input type="range" id="bGlow" min="0" max="50" value="10"></div>
        </div>
        <div class="grid3" style="margin-top:8px">
          <div><label>Grad A</label><input type="color" id="b1" value="#ff8a00"></div>
          <div><label>Grad B</label><input type="color" id="b2" value="#ffd000"></div>
          <div><label>Grad C</label><input type="color" id="b3" value="#ffa24c"></div>
        </div>
      </div>

      <!-- LOGOS -->
      <div class="section full">
        <h3>Logos (auto circle + auto-contrast border)</h3>
        <div class="row">
          <input type="file" id="logoInput" accept="image/*" multiple />
          <button class="btn" id="clearLogos">‚ùå Remove All</button>
          <button class="btn accent" id="alignLogos">‚ö° Auto Align</button>
        </div>
        <div id="logoList" style="margin-top:8px"></div>
        <div class="small" style="margin-top:6px">
          Drag logos ‚Ä¢ <b>Shift+Wheel</b> resize ‚Ä¢ Each logo has individual blend controls
        </div>
      </div>

      <!-- LAYERS -->
      <div class="section">
        <h3>Layer Management</h3>
        <div class="layer-panel" id="layerPanel">
          <div class="layer-item">
            <span>Background</span>
            <div>
              <input type="checkbox" checked disabled> üëÅÔ∏è
            </div>
          </div>
        </div>
      </div>

      <!-- HISTORY -->
      <div class="section">
        <h3>History & Export</h3>
        <div class="export-options">
          <button class="btn accent" id="exportPDF">üìÑ PDF</button>
          <button class="btn accent" id="exportSVG">üé® SVG</button>
          <button class="btn accent" id="batchExport">üì¶ Batch</button>
        </div>
        <div id="historyList" style="margin-top:8px; max-height:150px; overflow-y:auto;"></div>
      </div>

      <!-- SHORTCUTS -->
      <div class="section full">
        <div class="shortcut-help">
          <strong>‚å®Ô∏è Keyboard Shortcuts:</strong><br>
          <strong>Ctrl+S</strong> Save Settings ‚Ä¢ <strong>Ctrl+O</strong> Load Settings ‚Ä¢ <strong>Ctrl+Enter</strong> Download<br>
          <strong>Ctrl+Z</strong> Undo ‚Ä¢ <strong>Ctrl+Y</strong> Redo ‚Ä¢ <strong>Space</strong> Quick Preview
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
const c=document.getElementById('c'),ctx=c.getContext('2d'); 
const $=id=>document.getElementById(id);

// Enhanced state management with history
let history = [];
let historyIndex = -1;
const maxHistorySize = 50;

// Save state to history
function saveToHistory() {
  // Remove future history if we're not at the end
  if (historyIndex < history.length - 1) {
    history = history.slice(0, historyIndex + 1);
  }
  
  // Add current state
  history.push(JSON.stringify(getSettings()));
  
  // Limit history size
  if (history.length > maxHistorySize) {
    history.shift();
  } else {
    historyIndex++;
  }
  
  updateHistoryUI();
}

// Undo function
function undo() {
  if (historyIndex > 0) {
    historyIndex--;
    const state = JSON.parse(history[historyIndex]);
    loadSettings(state);
    showToast('Undo successful!');
  }
}

// Redo function
function redo() {
  if (historyIndex < history.length - 1) {
    historyIndex++;
    const state = JSON.parse(history[historyIndex]);
    loadSettings(state);
    showToast('Redo successful!');
  }
}

// Update history UI
function updateHistoryUI() {
  const undoBtn = $('undoBtn');
  const redoBtn = $('redoBtn');
  
  undoBtn.disabled = historyIndex <= 0;
  redoBtn.disabled = historyIndex >= history.length - 1;
  
  // Update history list
  const historyList = $('historyList');
  historyList.innerHTML = '';
  
  for (let i = Math.max(0, history.length - 10); i < history.length; i++) {
    const item = document.createElement('div');
    item.className = 'history-item';
    item.textContent = `State ${i + 1}${i === historyIndex ? ' (current)' : ''}`;
    item.onclick = () => {
      historyIndex = i;
      const state = JSON.parse(history[i]);
      loadSettings(state);
      updateHistoryUI();
      showToast('State restored!');
    };
    historyList.appendChild(item);
  }
}

// Global state
let BG = {bgImg: null, blendDir: 'none', blendStrength: 0};
let S = {logos: [], dragTarget: null, resizeTarget: null, dragOffset: {x: 0, y: 0}};

// Font management
const fonts = ['Noto Sans Devanagari', 'Poppins', 'Inter', 'Mukta', 'Hind', 'Karma', 'Martel'];
function loadFont(name) {
  if (document.fonts.check(`16px "${name}"`)) return;
  const link = document.createElement('link');
  link.href = `https://fonts.googleapis.com/css2?family=${name.replace(/ /g, '+')}:wght@400;600;800&display=swap`;
  link.rel = 'stylesheet';
  document.head.appendChild(link);
}

// Initialize font dropdowns
function initFonts() {
  const fontSelect = $('font');
  const topFontSelect = $('topFont');
  
  fonts.forEach(font => {
    const option1 = new Option(font, font);
    const option2 = new Option(font, font);
    fontSelect.add(option1);
    topFontSelect.add(option2);
  });
  
  fontSelect.value = 'Noto Sans Devanagari';
  topFontSelect.value = 'Noto Sans Devanagari';
}

// Templates
const templates = {
  social: {
    bg1: '#667eea', bg2: '#764ba2', bg3: '#ff6b6b',
    title: 'Social Media\nPost', titleSize: 80,
    brand: '@YourHandle', topTitle: 'Trending Now'
  },
  business: {
    bg1: '#2c3e50', bg2: '#34495e', bg3: '#1abc9c',
    title: 'Business\nSolution', titleSize: 72,
    brand: 'Company Name', topTitle: 'Professional'
  },
  event: {
    bg1: '#ff6b35', bg2: '#f7931e', bg3: '#ffd700',
    title: 'Special Event\nAnnouncement', titleSize: 64,
    brand: 'Join Us Today', topTitle: 'Don\'t Miss Out'
  },
  minimal: {
    bg1: '#ffffff', bg2: '#f8f9fa', bg3: '#e9ecef',
    title: 'Minimal\nDesign', titleSize: 96,
    brand: 'Less is More', topTitle: 'Simple'
  },
  vibrant: {
    bg1: '#ff0080', bg2: '#ff8c00', bg3: '#40e0d0',
    title: 'Vibrant\nColors', titleSize: 88,
    brand: 'Bold & Bright', topTitle: 'Eye-Catching'
  },
  elegant: {
    bg1: '#2d1b69', bg2: '#11998e', bg3: '#38ef7d',
    title: 'Elegant\nDesign', titleSize: 76,
    brand: 'Sophisticated', topTitle: 'Premium'
  }
};

function applyTemplate(templateName) {
  const template = templates[templateName];
  if (!template) return;
  
  Object.keys(template).forEach(key => {
    const element = $(key);
    if (element) {
      element.value = template[key];
    }
  });
  
  draw();
  saveToHistory();
  showToast(`Applied ${templateName} template!`);
}

// Progress bar functions
function showProgress() {
  $('progressBar').style.display = 'block';
}

function updateProgress(percent) {
  $('progressFill').style.width = percent + '%';
}

function hideProgress() {
  $('progressBar').style.display = 'none';
}

// Toast notifications
function showToast(message, type = 'success') {
  const toast = $('toast');
  toast.textContent = message;
  toast.className = `toast ${type}`;
  toast.classList.add('show');
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// Logo management
function addLogo(file) {
  const img = new Image();
  const reader = new FileReader();
  
  reader.onload = (e) => {
    img.onload = () => {
      const logo = {
        img, x: c.width/2, y: c.height/2, scale: 0.3, opacity: 1,
        bw: false, bcolor: '#ffffff', bopac: 0.8, autoBorder: true,
        blendDir: 'none', blendStrength: 0
      };
      S.logos.push(logo);
      rebuildLogoList();
      draw();
      saveToHistory();
      showToast('Logo added successfully!');
    };
    img.src = e.target.result;
  };
  
  reader.readAsDataURL(file);
}

function rebuildLogoList() {
  const list = $('logoList');
  list.innerHTML = '';
  
  S.logos.forEach((logo, i) => {
    const chip = document.createElement('div');
    chip.className = 'logo-chip';
    chip.innerHTML = `
      <div class="logo-header">
        <span class="logo-title">Logo ${i + 1}</span>
        <button onclick="removeLogo(${i})" style="background:var(--error);color:white;border:none;border-radius:4px;padding:2px 6px;cursor:pointer;">√ó</button>
      </div>
      <div class="logo-controls">
        <input type="range" min="0.1" max="2" step="0.05" value="${logo.scale}" onchange="S.logos[${i}].scale=+this.value;draw();" title="Scale">
        <input type="range" min="0" max="1" step="0.05" value="${logo.opacity}" onchange="S.logos[${i}].opacity=+this.value;draw();" title="Opacity">
        <input type="checkbox" ${logo.bw?'checked':''} onchange="S.logos[${i}].bw=this.checked;draw();" title="B&W">
        <input type="color" value="${logo.bcolor}" onchange="S.logos[${i}].bcolor=this.value;draw();" title="Border Color">
        <input type="range" min="0" max="1" step="0.05" value="${logo.bopac}" onchange="S.logos[${i}].bopac=+this.value;draw();" title="Border Opacity">
        <select onchange="S.logos[${i}].blendDir=this.value;draw();" title="Blend Direction">
          <option value="none" ${logo.blendDir==='none'?'selected':''}>None</option>
          <option value="top" ${logo.blendDir==='top'?'selected':''}>Top</option>
          <option value="bottom" ${logo.blendDir==='bottom'?'selected':''}>Bottom</option>
          <option value="left" ${logo.blendDir==='left'?'selected':''}>Left</option>
          <option value="right" ${logo.blendDir==='right'?'selected':''}>Right</option>
        </select>
      </div>
    `;
    list.appendChild(chip);
  });
}

function removeLogo(index) {
  S.logos.splice(index, 1);
  rebuildLogoList();
  draw();
  saveToHistory();
  showToast('Logo removed!');
}

function autoAlignLogos() {
  if (S.logos.length === 0) return;
  
  const spacing = c.width / (S.logos.length + 1);
  const y = c.height * 0.85;
  
  S.logos.forEach((logo, i) => {
    logo.x = spacing * (i + 1);
    logo.y = y;
  });
  
  draw();
  saveToHistory();
  showToast('Logos auto-aligned!');
}

// Export functions
function exportAsPDF() {
  showToast('PDF export would be implemented with jsPDF library');
}

function exportAsSVG() {
  showToast('SVG export would be implemented with custom SVG generation');
}

function batchExport() {
  const formats = ['png', 'jpeg', 'webp'];
  const scales = [1, 2, 3];
  
  showToast(`Batch export would generate ${formats.length * scales.length} files`);
}

// Drawing functions
function drawBackground() {
  const w = c.width, h = c.height;
  const pad = h * (+$('padding').value / 100);
  
  // Clear canvas
  ctx.clearRect(0, 0, w, h);
  
  // Background image handling
  if (BG.bgImg && ($('bgBlend').value === 'under' || $('bgBlend').value === 'imageOnly')) {
    ctx.save();
    const scale = +$('bgImgScale').value;
    const opacity = +$('bgImgOpacity').value;
    
    ctx.globalAlpha = opacity;
    
    // Apply tint
    const tintMode = $('bgTintMode').value;
    if (tintMode !== 'none') {
      ctx.globalCompositeOperation = tintMode;
      ctx.fillStyle = $('bgImgTint').value;
      ctx.fillRect(0, 0, w, h);
      ctx.globalCompositeOperation = 'source-over';
    }
    
    const imgW = BG.bgImg.width * scale;
    const imgH = BG.bgImg.height * scale;
    const imgX = (w - imgW) / 2;
    const imgY = (h - imgH) / 2;
    
    ctx.drawImage(BG.bgImg, imgX, imgY, imgW, imgH);
    
    // Apply directional blend
    if (BG.blendDir !== 'none' && BG.blendStrength > 0) {
      const gradient = ctx.createLinearGradient(
        BG.blendDir === 'left' ? 0 : BG.blendDir === 'right' ? w : w/2,
        BG.blendDir === 'top' ? 0 : BG.blendDir === 'bottom' ? h : h/2,
        BG.blendDir === 'left' ? w : BG.blendDir === 'right' ? 0 : w/2,
        BG.blendDir === 'top' ? h : BG.blendDir === 'bottom' ? 0 : h/2
      );
      
      gradient.addColorStop(0, `rgba(0,0,0,${BG.blendStrength})`);
      gradient.addColorStop(1, 'rgba(0,0,0,0)');
      
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, w, h);
    }
    
    ctx.restore();
  }
  
  // Gradient background
  if ($('bgBlend').value !== 'imageOnly') {
    ctx.save();
    ctx.globalAlpha = +$('gradOpacity').value;
    ctx.globalCompositeOperation = $('gradBlend').value;
    
    const angle = +$('bgAngle').value * Math.PI / 180;
    const centerX = w / 2, centerY = h / 2;
    const radius = Math.sqrt(w * w + h * h) / 2;
    
    const x1 = centerX - Math.cos(angle) * radius;
    const y1 = centerY - Math.sin(angle) * radius;
    const x2 = centerX + Math.cos(angle) * radius;
    const y2 = centerY + Math.sin(angle) * radius;
    
    const gradient = ctx.createLinearGradient(x1, y1, x2, y2);
    gradient.addColorStop(0, $('bg1').value);
    gradient.addColorStop(0.5, $('bg2').value);
    gradient.addColorStop(1, $('bg3').value);
    
    if ($('bgShape').value === 'circle') {
      const cx = w * (+$('circleX').value / 100);
      const cy = h * (+$('circleY').value / 100);
      const r = Math.min(w, h) * (+$('circleR').value / 100);
      
      ctx.globalAlpha *= +$('circleOpacity').value;
      ctx.beginPath();
      ctx.arc(cx, cy, r, 0, Math.PI * 2);
      ctx.fillStyle = gradient;
      ctx.fill();
    } else {
      ctx.fillStyle = gradient;
      ctx.fillRect(pad, pad, w - 2 * pad, h - 2 * pad);
    }
    
    ctx.restore();
  }
  
  // Background image over gradient
  if (BG.bgImg && $('bgBlend').value === 'over') {
    ctx.save();
    const scale = +$('bgImgScale').value;
    const opacity = +$('bgImgOpacity').value;
    
    ctx.globalAlpha = opacity;
    
    const imgW = BG.bgImg.width * scale;
    const imgH = BG.bgImg.height * scale;
    const imgX = (w - imgW) / 2;
    const imgY = (h - imgH) / 2;
    
    ctx.drawImage(BG.bgImg, imgX, imgY, imgW, imgH);
    ctx.restore();
  }
  
  // Vignette effect
  const vignetteStrength = +$('vignette').value;
  if (vignetteStrength > 0) {
    ctx.save();
    const gradient = ctx.createRadialGradient(w/2, h/2, 0, w/2, h/2, Math.max(w, h)/2);
    gradient.addColorStop(0, 'rgba(0,0,0,0)');
    gradient.addColorStop(1, `rgba(0,0,0,${vignetteStrength/100})`);
    
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, w, h);
    ctx.restore();
  }
}

function drawText(text, x, y, options = {}) {
  if (!text.trim()) return;
  
  const {
    font = 'Noto Sans Devanagari',
    size = 48,
    weight = '600',
    align = 'center',
    lineHeight = 1.15,
    letterSpacing = 0,
    colors = ['#40c9ff', '#f7b733'],
    angle = 0,
    outline = 0,
    glow = 0
  } = options;
  
  ctx.save();
  
  // Set font properties
  ctx.font = `${weight} ${size}px "${font}"`;
  ctx.textAlign = align;
  ctx.textBaseline = 'middle';
  
  // Handle multi-line text
  const lines = text.split('\n');
  const totalHeight = lines.length * size * lineHeight;
  const startY = y - totalHeight / 2 + size / 2;
  
  lines.forEach((line, i) => {
    const lineY = startY + i * size * lineHeight;
    
    // Apply letter spacing
    if (letterSpacing !== 0) {
      let currentX = x;
      if (align === 'center') {
        currentX = x - (ctx.measureText(line).width + letterSpacing * (line.length - 1)) / 2;
      }
      
      for (let j = 0; j < line.length; j++) {
        drawSingleChar(line[j], currentX, lineY, colors, angle, outline, glow);
        currentX += ctx.measureText(line[j]).width + letterSpacing;
      }
    } else {
      drawSingleChar(line, x, lineY, colors, angle, outline, glow);
    }
  });
  
  ctx.restore();
}

function drawSingleChar(char, x, y, colors, angle, outline, glow) {
  // Create gradient
  const gradient = ctx.createLinearGradient(
    x - 100, y - 50,
    x + 100, y + 50
  );
  
  if (colors.length >= 3) {
    gradient.addColorStop(0, colors[0]);
    gradient.addColorStop(0.5, colors[1]);
    gradient.addColorStop(1, colors[2]);
  } else {
    gradient.addColorStop(0, colors[0]);
    gradient.addColorStop(1, colors[1]);
  }
  
  // Glow effect
  if (glow > 0) {
    ctx.save();
    ctx.shadowColor = colors[0];
    ctx.shadowBlur = glow;
    ctx.globalAlpha = 0.6;
    ctx.fillStyle = gradient;
    ctx.fillText(char, x, y);
    ctx.restore();
  }
  
  // Outline
  if (outline > 0) {
    ctx.strokeStyle = 'rgba(0,0,0,0.8)';
    ctx.lineWidth = outline;
    ctx.lineJoin = 'round';
    ctx.strokeText(char, x, y);
  }
  
  // Main text
  ctx.fillStyle = gradient;
  ctx.fillText(char, x, y);
}

function drawLogos() {
  S.logos.forEach(logo => {
    ctx.save();
    
    // Apply logo transformations
    ctx.globalAlpha = logo.opacity;
    ctx.translate(logo.x, logo.y);
    
    const logoSize = Math.min(logo.img.width, logo.img.height) * logo.scale;
    const logoX = -logoSize / 2;
    const logoY = -logoSize / 2;
    
    // Auto-border with circle clipping
    if (logo.autoBorder) {
      // Draw border circle
      ctx.beginPath();
      ctx.arc(0, 0, logoSize / 2 + 8, 0, Math.PI * 2);
      ctx.fillStyle = logo.bcolor;
      ctx.globalAlpha = logo.bopac;
      ctx.fill();
      ctx.globalAlpha = logo.opacity;
      
      // Clip to circle
      ctx.beginPath();
      ctx.arc(0, 0, logoSize / 2, 0, Math.PI * 2);
      ctx.clip();
    }
    
    // Apply black & white filter
    if (logo.bw) {
      ctx.filter = 'grayscale(100%)';
    }
    
    // Draw logo
    ctx.drawImage(logo.img, logoX, logoY, logoSize, logoSize);
    
    ctx.restore();
  });
}

function draw() {
  // Update canvas size
  c.width = +$('cw').value;
  c.height = +$('ch').value;
  
  // Enable high-DPI rendering
  const dpr = window.devicePixelRatio || 1;
  const rect = c.getBoundingClientRect();
  
  c.width = rect.width * dpr;
  c.height = rect.height * dpr;
  ctx.scale(dpr, dpr);
  
  c.style.width = rect.width + 'px';
  c.style.height = rect.height + 'px';
  
  // Reset to actual dimensions for drawing
  c.width = +$('cw').value;
  c.height = +$('ch').value;
  
  drawBackground();
  
  // Draw top title
  const topTitle = $('topTitle').value;
  if (topTitle.trim()) {
    drawText(topTitle, c.width / 2, c.height * (+$('topY').value / 100), {
      font: $('topFont').value,
      size: +$('topSize').value,
      colors: [$('top1').value, $('top2').value],
      angle: +$('topAngle').value
    });
  }
  
  // Draw main title
  const title = $('title').value;
  if (title.trim()) {
    const isIndic = $('indicMode').value === 'forceOn' || 
                   ($('indicMode').value === 'auto' && /[\u0900-\u097F]/.test(title));
    
    drawText(title, c.width / 2, c.height * (+$('titleY').value / 100), {
      font: isIndic ? 'Noto Sans Devanagari' : $('font').value,
      size: +$('titleSize').value,
      weight: $('weight').value,
      align: $('align').value,
      lineHeight: +$('lineHeight').value,
      letterSpacing: +$('letter').value,
      colors: [$('t1').value, $('t2').value, $('t3').value],
      angle: +$('tAngle').value,
      outline: +$('outline').value,
      glow: +$('glow').value
    });
  }
  
  // Draw brand
  const brand = $('brand').value;
  if (brand.trim()) {
    drawText(brand, c.width / 2, c.height * (1 - +$('brandOffset').value / 100), {
      size: +$('brandSize').value,
      colors: [$('b1').value, $('b2').value, $('b3').value],
      glow: +$('bGlow').value
    });
  }
  
  // Draw logos
  drawLogos();
}

// Mouse interaction
let mousePos = {x: 0, y: 0};

function getMousePos(e) {
  const rect = c.getBoundingClientRect();
  const scaleX = c.width / rect.width;
  const scaleY = c.height / rect.height;
  
  return {
    x: (e.clientX - rect.left) * scaleX,
    y: (e.clientY - rect.top) * scaleY
  };
}

c.addEventListener('mousedown', (e) => {
  mousePos = getMousePos(e);
  
  // Check for logo hits
  for (let i = S.logos.length - 1; i >= 0; i--) {
    const logo = S.logos[i];
    const size = Math.min(logo.img.width, logo.img.height) * logo.scale;
    const dx = mousePos.x - logo.x;
    const dy = mousePos.y - logo.y;
    
    if (Math.sqrt(dx * dx + dy * dy) < size / 2) {
      S.dragTarget = logo;
      S.dragOffset = {x: dx, y: dy};
      break;
    }
  }
});

c.addEventListener('mousemove', (e) => {
  if (!S.dragTarget) return;
  
  mousePos = getMousePos(e);
  S.dragTarget.x = mousePos.x - S.dragOffset.x;
  S.dragTarget.y = mousePos.y - S.dragOffset.y;
  
  draw();
});

c.addEventListener('mouseup', () => {
  if (S.dragTarget) {
    saveToHistory();
  }
  S.dragTarget = null;
});

c.addEventListener('wheel', (e) => {
  e.preventDefault();
  
  if (!e.shiftKey) return;
  
  mousePos = getMousePos(e);
  
  // Find logo under cursor
  for (let i = S.logos.length - 1; i >= 0; i--) {
    const logo = S.logos[i];
    const size = Math.min(logo.img.width, logo.img.height) * logo.scale;
    const dx = mousePos.x - logo.x;
    const dy = mousePos.y - logo.y;
    
    if (Math.sqrt(dx * dx + dy * dy) < size / 2) {
      const delta = e.deltaY > 0 ? -0.05 : 0.05;
      logo.scale = Math.max(0.1, Math.min(2, logo.scale + delta));
      draw();
      break;
    }
  }
});

// File handling
$('bgImageInput').onchange = (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  const img = new Image();
  const reader = new FileReader();
  
  reader.onload = (e) => {
    img.onload = () => {
      BG.bgImg = img;
      draw();
      saveToHistory();
      showToast('Background image loaded!');
    };
    img.src = e.target.result;
  };
  
  reader.readAsDataURL(file);
};

$('logoInput').onchange = (e) => {
  Array.from(e.target.files).forEach(addLogo);
  e.target.value = ''; // Reset input
};

$('clearLogos').onclick = () => {
  S.logos = [];
  rebuildLogoList();
  draw();
  saveToHistory();
  showToast('All logos cleared!');
};

// Settings Save/Load System (Enhanced)
function getSettings() {
  return {
    // Background settings
    bg1: $('bg1').value,
    bg2: $('bg2').value,
    bg3: $('bg3').value,
    bgAngle: $('bgAngle').value,
    gradOpacity: $('gradOpacity').value,
    bgBlend: $('bgBlend').value,
    bgShape: $('bgShape').value,
    vignette: $('vignette').value,
    padding: $('padding').value,
    bgImgOpacity: $('bgImgOpacity').value,
    bgImgScale: $('bgImgScale').value,
    bgImgTint: $('bgImgTint').value,
    bgBlendDir: $('bgBlendDir').value,
    bgBlendStrength: $('bgBlendStrength').value,
    bgTintMode: $('bgTintMode').value,
    gradBlend: $('gradBlend').value,
    
    // Circle settings
    circleX: $('circleX').value,
    circleY: $('circleY').value,
    circleR: $('circleR').value,
    circleOpacity: $('circleOpacity').value,
    
    // Text settings
    topTitle: $('topTitle').value,
    topFont: $('topFont').value,
    topSize: $('topSize').value,
    topY: $('topY').value,
    top1: $('top1').value,
    top2: $('top2').value,
    topAngle: $('topAngle').value,
    
    title: $('title').value,
    font: $('font').value,
    weight: $('weight').value,
    titleSize: $('titleSize').value,
    lineHeight: $('lineHeight').value,
    letter: $('letter').value,
    align: $('align').value,
    t1: $('t1').value,
    t2: $('t2').value,
    t3: $('t3').value,
    tAngle: $('tAngle').value,
    outline: $('outline').value,
    glow: $('glow').value,
    titleY: $('titleY').value,
    indicMode: $('indicMode').value,
    
    brand: $('brand').value,
    brandSize: $('brandSize').value,
    brandOffset: $('brandOffset').value,
    bGlow: $('bGlow').value,
    b1: $('b1').value,
    b2: $('b2').value,
    b3: $('b3').value,
    
    // Canvas settings
    preset: $('preset').value,
    cw: $('cw').value,
    ch: $('ch').value,
    
    // Logos (excluding image data)
    logoCount: S.logos.length,
    logoSettings: S.logos.map(L => ({
      x: L.x, y: L.y, scale: L.scale, opacity: L.opacity,
      bw: L.bw, bcolor: L.bcolor, bopac: L.bopac, 
      autoBorder: L.autoBorder, blendDir: L.blendDir, 
      blendStrength: L.blendStrength
    }))
  };
}

function loadSettings(settings) {
  Object.keys(settings).forEach(key => {
    if(key === 'logoCount' || key === 'logoSettings') return;
    const element = $(key);
    if(element) {
      element.value = settings[key];
      if(element.type === 'checkbox') {
        element.checked = settings[key];
      }
    }
  });
  
  // Apply logo settings if available
  if(settings.logoSettings && S.logos.length === settings.logoSettings.length) {
    settings.logoSettings.forEach((logoSettings, i) => {
      if(S.logos[i]) {
        Object.assign(S.logos[i], logoSettings);
      }
    });
    rebuildLogoList();
  }
  
  // Update UI state
  document.getElementById('circleControls').style.display = 
    $('bgShape').value === 'circle' ? 'grid' : 'none';
  
  // Update BG state
  BG.blendDir = $('bgBlendDir').value;
  BG.blendStrength = +$('bgBlendStrength').value;
  
  draw();
}

$('saveSettings').onclick = () => {
  const settings = getSettings();
  const blob = new Blob([JSON.stringify(settings, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `post_maker_settings_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('Settings saved successfully!');
};

$('loadSettings').onclick = () => {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = (e) => {
    const file = e.target.files[0];
    if(!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const settings = JSON.parse(e.target.result);
        loadSettings(settings);
        saveToHistory();
        showToast('Settings loaded successfully!');
      } catch(err) {
        showToast('Error loading settings file!', 'error');
      }
    };
    reader.readAsText(file);
  };
  input.click();
};

// Event bindings (Enhanced)
document.querySelectorAll('input,select,textarea').forEach(el=>el.addEventListener('input',()=>{
  if(el.id==='font'||el.id==='topFont') loadFont(el.value);
  if(el.id==='bgShape'){ 
    document.getElementById('circleControls').style.display = el.value==='circle'?'grid':'none'; 
  }
  
  BG.blendDir=$('bgBlendDir').value; 
  BG.blendStrength=+$('bgBlendStrength').value;
  draw();
  
  // Auto-save to history on significant changes
  if(['title', 'topTitle', 'brand', 'bg1', 'bg2', 'bg3'].includes(el.id)) {
    clearTimeout(el.autoSaveTimeout);
    el.autoSaveTimeout = setTimeout(saveToHistory, 1000);
  }
}));

document.getElementById('preset').addEventListener('change',()=>{ 
  const v=$('preset').value; 
  if(v!=='custom'){ 
    const [w,h]=v.split('x').map(Number); 
    $('cw').value=w; 
    $('ch').value=h; 
  } 
  draw(); 
  saveToHistory();
});

// Enhanced Download function
$('download').onclick=()=>{
  const scale=+$('scale').value, fmt=$('format').value, q=+$('quality').value;
  
  showProgress();
  updateProgress(20);
  
  const tmp=document.createElement('canvas'); 
  tmp.width=c.width*scale; 
  tmp.height=c.height*scale;
  const t=tmp.getContext('2d'); 
  t.imageSmoothingQuality='high'; 
  t.scale(scale, scale);
  
  updateProgress(50);
  
  // Redraw everything on scaled canvas
  const originalCanvas = c;
  const originalCtx = ctx;
  
  // Temporarily replace canvas context for drawing
  window.c = tmp;
  window.ctx = t;
  
  draw();
  
  // Restore original canvas
  window.c = originalCanvas;
  window.ctx = originalCtx;
  
  updateProgress(80);
  
  const mime= fmt==='png'?'image/png':(fmt==='jpeg'?'image/jpeg':'image/webp');
  const url=tmp.toDataURL(mime,q); 
  const a=document.createElement('a'); 
  a.href=url; 
  a.download=`post_${tmp.width}x${tmp.height}_${Date.now()}.${fmt}`; 
  a.click();
  
  updateProgress(100);
  hideProgress();
  showToast(`Download completed! ${tmp.width}√ó${tmp.height} ${fmt.toUpperCase()}`);
};

// Enhanced Event Listeners
$('undoBtn').onclick = undo;
$('redoBtn').onclick = redo;
$('alignLogos').onclick = autoAlignLogos;
$('exportPDF').onclick = exportAsPDF;
$('exportSVG').onclick = exportAsSVG;
$('batchExport').onclick = batchExport;

// Template event listeners
document.querySelectorAll('.template-item').forEach(item => {
  item.onclick = () => applyTemplate(item.dataset.template);
});

// Enhanced keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if(e.ctrlKey || e.metaKey) {
    switch(e.key) {
      case 's':
        e.preventDefault();
        $('saveSettings').click();
        break;
      case 'o':
        e.preventDefault();
        $('loadSettings').click();
        break;
      case 'Enter':
        e.preventDefault();
        $('download').click();
        break;
      case 'z':
        if(!e.shiftKey) {
          e.preventDefault();
          undo();
        }
        break;
      case 'y':
        e.preventDefault();
        redo();
        break;
    }
  }
  
  // Space for quick preview
  if(e.code === 'Space' && !e.ctrlKey && !e.shiftKey) {
    e.preventDefault();
    c.style.transform = c.style.transform ? '' : 'scale(1.1)';
    setTimeout(() => {
      c.style.transform = '';
    }, 200);
  }
});

// Initialize
initFonts();
loadFont("Noto Sans Devanagari"); 
loadFont("Poppins");
document.getElementById('circleControls').style.display = $('bgShape').value==='circle'?'grid':'none';

// Save initial state to history
setTimeout(() => {
  saveToHistory();
  updateHistoryUI();
}, 100);

// Auto-draw on load
draw();

console.log('üé® Enhanced Post Maker loaded successfully!');
console.log('‚ú® New features: Templates, Undo/Redo, Auto-align, Progress bars, Enhanced exports');
console.log('‚å®Ô∏è Shortcuts: Ctrl+S (Save), Ctrl+O (Load), Ctrl+Z (Undo), Ctrl+Y (Redo), Space (Preview)');
</script>
</body>
</html>
